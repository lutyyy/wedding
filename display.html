<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>婚禮即時祝福牆</title>
  <!-- 字型 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=ZCOOL+KuaiLe&family=Ma+Shan+Zheng&family=Baloo+Bhaijaan+2:wght@600;700&family=Pacifico&family=Luckiest+Guy&display=swap" rel="stylesheet">

  <style>
    /* 基本與背景層：避免 mobile 上 background-attachment: fixed 抖動 */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100dvh;         /* 動態視窗高，避免地址列收放跳動 */
      overflow: hidden;        /* 不捲動頁面 */
      font-family: 'Noto Sans TC', sans-serif;
      position: fixed;         /* 鎖住視窗，避免被動畫「牽著」位移 */
      inset: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: none;      /* 防止拉動/橡皮筋效果 */
      background: #000;        /* 背景底色，避免圖片載入前閃白 */
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('https://i.meee.com.tw/QdTRWCS.jpg') center center / cover no-repeat;
      z-index: -1;
      transform: translateZ(0);
      will-change: transform;
    }

    /* 可選標題（若不需要可移除 h1 與 #titleBox） */
    #titleBox {
      width: 100vw;
      z-index: 90;
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    h1 {
      color: #ff3d6a;
      text-align: center;
      margin: 1vh 0 2vh 0;
      font-size: 2.7em;
      font-family: 'Luckiest Guy', cursive, 'Noto Sans TC', sans-serif;
      text-shadow: 0 0 12px #fff8;
      z-index: 99;
      position: relative;
    }

    /* 彈幕 */
    .danmu {
      position: fixed;         /* 脫離文件流，完全不影響版面 */
      white-space: nowrap;
      font-weight: bold;
      font-size: 2.2em;
      pointer-events: none;
      text-shadow: 1px 2px 16px #fff8, 0 0 8px #ffb6cf88;
      user-select: none;
      opacity: 0.92;
      z-index: 10;
      transition: opacity 0.3s;
      will-change: transform;   /* 交給合成層 */
      contain: paint;           /* 限縮繪製影響範圍 */
      transform: translateZ(0);
    }

    /* POP 中央彈出 */
    .pop-message {
      position: fixed;
      left: 50%;
      top: 45%;
      transform: translate(-50%, -50%) scale(0.7);
      background: #fff9c4;
      color: #ff3d6a;
      border-radius: 35px;
      padding: 0.6em 2em;
      font-size: 2.3em;
      font-weight: bold;
      box-shadow: 0 8px 32px #e88ad633;
      border: 3px solid #ff3d6a33;
      opacity: 0;
      animation: pop-in 0.5s cubic-bezier(.3,1.8,.6,1.0) forwards,
                 pop-out 0.8s linear 2.8s forwards;
      z-index: 100;
      font-family: 'ZCOOL KuaiLe', 'Ma Shan Zheng', 'Pacifico', 'Baloo Bhaijaan 2', 'Luckiest Guy', cursive, 'Noto Sans TC', sans-serif;
      text-shadow: 0 0 14px #fff8, 0 2px 24px #ffb6cf55;
      will-change: transform, opacity;
    }
    @keyframes pop-in {
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    @keyframes pop-out {
      to { opacity: 0; transform: translate(-50%, -55%) scale(0.9); }
    }

    /* 低動態模式友善（使用者偏好減少動畫） */
    @media (prefers-reduced-motion: reduce) {
      .danmu { animation: none !important; transition: none !important; }
      .pop-message { animation: none !important; opacity: 1 !important; }
    }
  </style>
</head>
<body>
  <!-- 若要顯示標題，取消註解以下兩行 -->
  <!-- <div id="titleBox"><h1>婚禮即時祝福牆</h1></div> -->

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // 你的 firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyDGUl6MonqDlxqhz7S2b3pN-_oLNgKt04w",
      authDomain: "wedding-wall-4acb1.firebaseapp.com",
      databaseURL: "https://wedding-wall-4acb1-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wedding-wall-4acb1",
      storageBucket: "wedding-wall-4acb1.firebasestorage.app",
      messagingSenderId: "161250703119",
      appId: "1:161250703119:web:08433b339f70e7138cb07a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 字型與顏色
    const fontList = [
      "'ZCOOL KuaiLe', cursive",
      "'Ma Shan Zheng', cursive",
      "'Pacifico', cursive",
      "'Baloo Bhaijaan 2', cursive",
      "'Luckiest Guy', cursive",
      "'Noto Sans TC', sans-serif"
    ];
    const colorList = [
      "#ff3d6a", "#c959ff", "#ffbc1f", "#1ec19d", "#4d83ff", "#6f2dff", "#ec008c", "#f28500"
    ];

    let messages = [{ text: "祝福新人幸福快樂！", ts: Date.now(), id: "default" }];
    const shownPopIds = new Set();
    const danmuNowShowing = new Set(); // 目前在畫面上的留言 id

    // 建立彈幕（用 transform 動畫，避免 reflow）
    function createDanmu(msg) {
      danmuNowShowing.add(msg.id);
      const danmu = document.createElement('div');
      danmu.className = 'danmu';
      danmu.textContent = msg.text;
      danmu.style.fontFamily = fontList[Math.floor(Math.random() * fontList.length)];
      danmu.style.color = colorList[Math.floor(Math.random() * colorList.length)];
      danmu.style.fontSize = (2 + Math.random() * 1.5) + "em";

      const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
      const y = 10 + Math.random() * (vh - 120);
      danmu.style.top = y + "px";

      const duration = 8000 + Math.random() * 6000; // 8~14s
      const dir = Math.random() > 0.5 ? 1 : 0;

      // 放到畫面上再開始動畫，避免計算抖動
      document.body.appendChild(danmu);

      if (dir === 0) {
        // 左 -> 右（確保完全離開螢幕，使用 +/-110vw）
        danmu.style.transform = 'translateX(-110vw)';
        const anim = danmu.animate(
          [{ transform: 'translateX(-110vw)' }, { transform: 'translateX(110vw)' }],
          { duration, easing: 'linear' }
        );
        anim.onfinish = () => { danmu.remove(); danmuNowShowing.delete(msg.id); };
      } else {
        // 右 -> 左
        danmu.style.transform = 'translateX(110vw)';
        const anim = danmu.animate(
          [{ transform: 'translateX(110vw)' }, { transform: 'translateX(-110vw)' }],
          { duration, easing: 'linear' }
        );
        anim.onfinish = () => { danmu.remove(); danmuNowShowing.delete(msg.id); };
      }
    }

    // 定時新增彈幕
    function danmuScheduler() {
      if (!messages || messages.length === 0) return;

      // 每次 1~2 條，避免同場動畫過多
      const n = 1 + Math.floor(Math.random() * 2);
      const available = messages.filter(m => !danmuNowShowing.has(m.id));
      if (available.length === 0) return;

      for (let i = 0; i < n && available.length > 0; i++) {
        const pick = Math.floor(Math.random() * available.length);
        const msg = available[pick];
        createDanmu(msg);
        available.splice(pick, 1);
      }
    }

    // 新 pop 留言顯示（中央彈出）
    function showPopMessages(newMsgs) {
      newMsgs.forEach(m => {
        const el = document.createElement('div');
        el.className = 'pop-message';
        el.textContent = m.text;
        el.style.fontFamily = fontList[Math.floor(Math.random() * fontList.length)];
        el.style.color = colorList[Math.floor(Math.random() * colorList.length)];
        document.body.appendChild(el);
        setTimeout(() => { el.remove(); }, 3500);
      });
    }

    // 監控 Firebase
    db.ref('messages').on('value', (snap) => {
      const now = Date.now();
      let list = [];
      let newPops = [];
      snap.forEach(child => {
        const v = child.val();
        const item = { text: v.text, ts: v.ts, id: child.key };
        list.push(item);
        if (v.ts && now - v.ts <= 60000 && !shownPopIds.has(child.key)) {
          newPops.push({ text: v.text, id: child.key });
          shownPopIds.add(child.key);
        }
      });
      if (list.length === 0) list = [{ text: "祝福新人幸福快樂！", ts: now, id: "default" }];
      messages = list;
      if (newPops.length > 0) showPopMessages(newPops);
    });

    // 彈幕排程
    const SCHEDULE_MS = 3000;   // 手機上更穩的節奏（原 2500ms）
    setInterval(danmuScheduler, SCHEDULE_MS);

    // 進場先秀幾條
    setTimeout(danmuScheduler, 400);
    setTimeout(danmuScheduler, 1800);

    // 鎖定視窗尺寸（避免 resize 造成跳動）
    window.addEventListener('resize', () => {});
  </script>
</body>
</html>
