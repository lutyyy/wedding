<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å©šç¦®å³æ™‚ç¥ç¦ç‰†</title>
  <!-- å­—å‹ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=ZCOOL+KuaiLe&family=Ma+Shan+Zheng&family=Baloo+Bhaijaan+2:wght@600;700&family=Pacifico&family=Luckiest+Guy&display=swap" rel="stylesheet">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100dvh;
      overflow: hidden;
      font-family: 'Noto Sans TC', sans-serif;
      position: fixed;
      inset: 0;
      background: #000;
      touch-action: none;
      -webkit-font-smoothing: antialiased;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('https://l.urusai.cc/zx8Hf.jpg') center center / cover no-repeat;
      z-index: -1;
      transform: translateZ(0);
    }

    .chip {
      position: fixed;
      top: calc(10px + env(safe-area-inset-top));
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.82);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border: 1px solid #ffffff66;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
      color: #ff3d6a;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      pointer-events: none;
      z-index: 200;
      white-space: nowrap;
      text-shadow: 0 1px 8px #fff8;
    }
    .live-chip { left: 12px; font-size: 15px; }
    .hint-chip { right: 12px; font-size: 14px; }
    .dot {
      width: 10px; height: 10px; border-radius: 999px;
      background: #aaa;
      box-shadow: 0 0 0 0 rgba(0,230,118,0);
    }
    .dot.pulse { animation: pulse 1.6s ease-out infinite; background: #00e676; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0,230,118,.7); }
      70% { box-shadow: 0 0 0 12px rgba(0,230,118,0); }
      100% { box-shadow: 0 0 0 0 rgba(0,230,118,0); }
    }
    @media (max-width: 420px) {
      .hint-chip { display: none; }
    }

    /* ===== èª¿å¤§å­—å‹ã€æ…¢é€Ÿå‹•ç•« ===== */
    .danmu {
      position: fixed;
      white-space: nowrap;
      font-weight: bold;
      font-size: 3.8em; /* åŸ 2.2emï¼Œç¾åœ¨æ›´å¤§ */
      pointer-events: none;
      text-shadow: 1px 2px 16px #fff8, 0 0 8px #ffb6cf88;
      user-select: none;
      opacity: 0.92;
      z-index: 10;
      will-change: transform;
      contain: paint;
      transform: translateZ(0);
    }

    .pop-message {
      position: fixed;
      left: 50%;
      top: 45%;
      transform: translate(-50%, -50%) scale(0.7);
      background: #fff9c4;
      color: #ff3d6a;
      border-radius: 35px;
      padding: 0.6em 2.5em;
      font-size: 3.3em; /* åŸ 2.3emï¼Œç¾åœ¨æ›´å¤§ */
      font-weight: bold;
      box-shadow: 0 8px 32px #e88ad633;
      border: 3px solid #ff3d6a33;
      opacity: 0;
      animation: pop-in 0.7s cubic-bezier(.3,1.8,.6,1.0) forwards,
                 pop-out 1.2s linear 3.2s forwards;
      z-index: 100;
      font-family: 'ZCOOL KuaiLe', 'Ma Shan Zheng', 'Pacifico', 'Baloo Bhaijaan 2', 'Luckiest Guy', cursive, 'Noto Sans TC', sans-serif;
      text-shadow: 0 0 14px #fff8, 0 2px 24px #ffb6cf55;
      will-change: transform, opacity;
    }
    @keyframes pop-in { to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
    @keyframes pop-out { to { opacity: 0; transform: translate(-50%, -55%) scale(0.9); } }

    .heart {
      position: fixed;
      left: 50%;
      top: 100vh;
      transform: translateX(-50%) translateY(0) scale(1);
      font-size: 5.5em; /* åŸ 3.6emï¼Œç¾åœ¨æ›´å¤§ */
      filter: drop-shadow(0 8px 16px #ff3d6a66);
      pointer-events: none;
      z-index: 50;
      opacity: 0.95;
      animation: floatUp 5.2s ease-out forwards; /* åŸ 3.2sï¼Œç¾åœ¨æ›´æ…¢ */
      will-change: transform, opacity;
    }
    @keyframes floatUp {
      0%   { transform: translateY(0) translateX(0) scale(0.9); opacity: 0.9; }
      60%  { transform: translateY(-70vh) translateX(var(--drift, 0px)) scale(1.05); opacity: 1; }
      100% { transform: translateY(-120vh) translateX(var(--drift, 0px)) scale(1.05); opacity: 0; }
    }

    @media (prefers-reduced-motion: reduce) {
      .danmu, .pop-message, .heart { animation: none !important; transition: none !important; opacity: 1 !important; }
    }
  </style>
</head>
<body>
  <div class="chip live-chip">
    <span class="dot" id="liveDot"></span>
    <span id="liveText">LIVEï¼šå³æ™‚ç¥ç¦é€£ç·šä¸­</span>
  </div>
  <div class="chip hint-chip">æƒææ¡Œå¡é€ä¸Šç¥ç¦ ğŸ’Œï¼ˆ50 å­—å…§ï¼‰</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyDGUl6MonqDlxqhz7S2b3pN-_oLNgKt04w",
      authDomain: "wedding-wall-4acb1.firebaseapp.com",
      databaseURL: "https://wedding-wall-4acb1-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wedding-wall-4acb1",
      storageBucket: "wedding-wall-4acb1.firebasestorage.app",
      messagingSenderId: "161250703119",
      appId: "1:161250703119:web:08433b339f70e7138cb07a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ======= LIVE ç‹€æ…‹æŒ‡ç¤º =======
    (function setupLiveBadge(){
      const liveDot = document.getElementById('liveDot');
      const liveText = document.getElementById('liveText');
      db.ref('.info/connected').on('value', snap => {
        const connected = snap.val() === true;
        if (connected) {
          liveDot.classList.add('pulse');
          liveText.textContent = 'LIVEï¼šå³æ™‚ç¥ç¦é€£ç·šä¸­';
        } else {
          liveDot.classList.remove('pulse');
          liveDot.style.background = '#aaa';
          liveText.textContent = 'OFFLINEï¼šæš«æ™‚æ–·ç·šï¼Œé‡è©¦ä¸­â€¦';
        }
      });
    })();

    // ======= å½ˆå¹•ç³»çµ± =======
    const fontList = [
      "'ZCOOL KuaiLe', cursive", "'Ma Shan Zheng', cursive",
      "'Pacifico', cursive", "'Baloo Bhaijaan 2', cursive",
      "'Luckiest Guy', cursive", "'Noto Sans TC', sans-serif"
    ];
    const colorList = ["#ff3d6a","#c959ff","#ffbc1f","#1ec19d","#4d83ff","#6f2dff","#ec008c","#f28500"];

    let messages = [{ text: "ç¥ç¦æ–°äººå¹¸ç¦å¿«æ¨‚ï¼", ts: Date.now(), id: "default" }];
    const shownPopIds = new Set();
    const danmuNowShowing = new Set();

    function createDanmu(msg) {
      danmuNowShowing.add(msg.id);
      const danmu = document.createElement('div');
      danmu.className = 'danmu';
      danmu.textContent = msg.text;
      danmu.style.fontFamily = fontList[Math.floor(Math.random() * fontList.length)];
      danmu.style.color = colorList[Math.floor(Math.random() * colorList.length)];
      danmu.style.fontSize = (3.5 + Math.random() * 1.3) + "em"; // æ¯”åŸæœ¬æ›´å¤§

      const vh = window.innerHeight;
      const y = 10 + Math.random() * (vh - 170);
      danmu.style.top = y + "px";
      const duration = 15500 + Math.random() * 4500; // æ¯”åŸæœ¬æ…¢
      const dir = Math.random() > 0.5 ? 1 : 0;
      document.body.appendChild(danmu);
      const anim = danmu.animate(
        dir === 0 ?
          [{ transform: 'translateX(-110vw)' }, { transform: 'translateX(110vw)' }] :
          [{ transform: 'translateX(110vw)' }, { transform: 'translateX(-110vw)' }],
        { duration, easing: 'linear' }
      );
      anim.onfinish = () => { danmu.remove(); danmuNowShowing.delete(msg.id); };
    }

    function danmuScheduler() {
      if (!messages || messages.length === 0) return;
      const n = 1 + Math.floor(Math.random() * 2);
      const available = messages.filter(m => !danmuNowShowing.has(m.id));
      for (let i = 0; i < n && available.length > 0; i++) {
        const pick = Math.floor(Math.random() * available.length);
        createDanmu(available[pick]);
        available.splice(pick, 1);
      }
    }

    function showPopMessages(newMsgs) {
      newMsgs.forEach(m => {
        const el = document.createElement('div');
        el.className = 'pop-message';
        el.textContent = m.text;
        el.style.fontFamily = fontList[Math.floor(Math.random() * fontList.length)];
        el.style.color = colorList[Math.floor(Math.random() * colorList.length)];
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 4100); // å½ˆå‡ºç¨å¾®ä¹…ä¸€é»
      });
    }

    function showHeartBurst() {
      const count = 8 + Math.floor(Math.random() * 5);
      for (let i = 0; i < count; i++) {
        const heart = document.createElement('div');
        heart.className = 'heart';
        heart.textContent = Math.random() < 0.15 ? 'ğŸ’˜' : (Math.random() < 0.5 ? 'ğŸ’–' : 'â¤ï¸');
        const startX = 10 + Math.random() * 80;
        const size = 4 + Math.random() * 2.2;
        const drift = (Math.random() * 120 - 60) + 'px';
        heart.style.left = startX + 'vw';
        heart.style.fontSize = size + 'em';
        heart.style.setProperty('--drift', drift);
        const delay = Math.random() * 350;
        setTimeout(() => {
          document.body.appendChild(heart);
          setTimeout(() => heart.remove(), 5400);
        }, delay);
      }
    }

    // Firebase ç›£è½
    db.ref('messages').on('value', (snap) => {
      const now = Date.now();
      let list = [];
      let newPops = [];
      snap.forEach(child => {
        const v = child.val();
        const item = { text: v.text, ts: v.ts, id: child.key };
        list.push(item);
        if (v.ts && now - v.ts <= 60000 && !shownPopIds.has(child.key)) {
          newPops.push(item);
          shownPopIds.add(child.key);
        }
      });
      if (list.length === 0) list = [{ text: "ç¥ç¦æ–°äººå¹¸ç¦å¿«æ¨‚ï¼", ts: now, id: "default" }];
      messages = list;
      if (newPops.length > 0) showPopMessages(newPops);
    });

    // âœ… æ–°å¢å¤šç¨®äº’å‹•ç‰¹æ•ˆç›£è½
    const startNow = Date.now();
    db.ref('interactions')
      .orderByChild('ts')
      .startAt(startNow)
      .on('child_added', (snap) => {
        const v = snap.val();
        if (!v?.type) return;
        switch (v.type) {
          case 'heart':   showHeartBurst();  break;
          case 'flower':  showConfetti();    break;
          case 'balloon': showBalloons();    break;
          case 'firework':showFireworks();   break;
        }
      });

    // å½ˆå¹•é€Ÿåº¦æ…¢ä¸€é»
    setInterval(danmuScheduler, 5200);
    setTimeout(danmuScheduler, 1500);
    setTimeout(danmuScheduler, 3400);

    // äº’å‹•ç‰¹æ•ˆï¼šå­—å‹å…¨æ”¾å¤§ã€å‹•ç•«æ™‚é–“è®Šæ…¢
    function showConfetti() {
      for (let i = 0; i < 44; i++) {
        const el = document.createElement('div');
        el.textContent = ['ğŸ‰', 'âœ¨', 'ğŸ’«', 'ğŸŒ¸'][Math.floor(Math.random() * 4)];
        el.style.position = 'fixed';
        el.style.left = Math.random() * 100 + 'vw';
        el.style.top = '-5vh';
        el.style.fontSize = (2.2 + Math.random() * 1.8) + 'em';
        el.style.opacity = 0.97;
        el.style.zIndex = 80;
        el.style.transition = 'transform 5.5s ease-out, opacity 5.5s';
        document.body.appendChild(el);
        setTimeout(() => {
          el.style.transform = `translateY(${110 + Math.random() * 20}vh) rotate(${Math.random() * 720}deg)`;
          el.style.opacity = 0;
        }, 80);
        setTimeout(() => el.remove(), 6000);
      }
    }

    function showBalloons() {
      for (let i = 0; i < 14; i++) {
        const el = document.createElement('div');
        el.textContent = ['ğŸˆ', 'ğŸˆ', 'ğŸŠ'][Math.floor(Math.random() * 3)];
        el.style.position = 'fixed';
        el.style.left = 10 + Math.random() * 80 + 'vw';
        el.style.bottom = '-10vh';
        el.style.fontSize = (3 + Math.random() * 2.5) + 'em';
        el.style.transition = 'transform 7s ease-out, opacity 7s';
        el.style.zIndex = 60;
        document.body.appendChild(el);
        setTimeout(() => {
          el.style.transform = `translateY(-120vh) translateX(${Math.random() * 80 - 40}px)`;
          el.style.opacity = 0;
        }, 100);
        setTimeout(() => el.remove(), 7300);
      }
    }

    function showFireworks() {
      for (let i = 0; i < 18; i++) {
        const el = document.createElement('div');
        el.textContent = ['ğŸ’¥', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«'][Math.floor(Math.random() * 4)];
        el.style.position = 'fixed';
        el.style.left = 20 + Math.random() * 60 + 'vw';
        el.style.top = 30 + Math.random() * 40 + 'vh';
        el.style.fontSize = (3.5 + Math.random() * 2) + 'em';
        el.style.zIndex = 90;
        el.style.opacity = 0;
        document.body.appendChild(el);
        setTimeout(() => {
          el.style.transition = 'opacity 0.4s';
          el.style.opacity = 1;
        }, 120);
        setTimeout(() => {
          el.style.transition = 'opacity 1.1s';
          el.style.opacity = 0;
        }, 1000 + Math.random() * 800);
        setTimeout(() => el.remove(), 2400);
      }
    }
  </script>
</body>
</html>
